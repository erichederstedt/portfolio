<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Global Illumination - Eric Hederstedt</title><meta name="description" content="Overview The main goal of this project was to improve the lighting quality in our game engine by adding a source of indirect global illumination. Realistic lighting is a crucial aspect of creating immersive and visually appealing virtual environments, and global illumination (GI) plays a&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="stylesheet" href="./media/plugins/syntaxHighlighter/prism-black.css"><link rel="canonical" href="./global-illumination-2.html"><link rel="stylesheet" href="./assets/css/style.css?v=44d9a987fb5b01f47d4f9a8a96093776"><link rel="stylesheet" href="./assets/css/photoswipe.css?v=366561c4c503c68e3af3389ac4d7fb8e"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"./global-illumination-2.html"},"headline":"Global Illumination","datePublished":"2024-04-08T19:48","dateModified":"2024-04-08T20:02","description":"Overview The main goal of this project was to improve the lighting quality in our game engine by adding a source of indirect global illumination. Realistic lighting is a crucial aspect of creating immersive and visually appealing virtual environments, and global illumination (GI) plays a&hellip;","author":{"@type":"Person","name":"Eric Hederstedt","url":"./authors/eric-hederstedt/"},"publisher":{"@type":"Organization","name":"Eric Hederstedt"}}</script><style>.pswp--svg .pswp__button,
				          .pswp--svg .pswp__button--arrow--left:before,
				          .pswp--svg .pswp__button--arrow--right:before {
					          background-image: url(./assets/svg/gallery-icons-light.svg);
			              }</style><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><style>.fi{fill:none;stroke-linecap:round;stroke-linejoin:round;vertical-align:middle}</style></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="./">Eric Hederstedt</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li class="has-submenu"><span class="is-separator" title="Test" aria-haspopup="true">Projects</span><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="./tga-project-7-streamer-attacked-by-aliens.html" title="Test" target="_self">P7</a></li><li><a href="./tga-project-6-spite-string-of-fate.html" title="Test" target="_self">P6</a></li><li><a href="./tga-project-5-laboratoriya-the-laboratory.html" title="Test" target="_self">P5</a></li></ul></li><li><a href="./about-2.html" title="Test" target="_self">About</a></li></ul></nav></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><h1>Global Illumination</h1></div></header></div><div class="wrapper post__entry"><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1hqvdsa0k15s">Overview</a></li><li><a href="#mcetoc_1hqvdsa0k15t">Results</a></li><li><a href="#mcetoc_1hqvdsa0k15u">Techical Implementation</a></li></ul></div><h2 id="mcetoc_1hqvdsa0k15s">Overview</h2><p>The main goal of this project was to improve the lighting quality in our game engine by adding a source of indirect global illumination. Realistic lighting is a crucial aspect of creating immersive and visually appealing virtual environments, and global illumination (GI) plays a significant role in achieving this. GI simulates the way light bounces and reflects off surfaces, creating indirect lighting effects that contribute to the overall realism and atmosphere of a scene.<br><br>The GI method I chose to implement was grid-placed light probes containing order 3 spherical harmonic coefficients. This approach is a classic and practical way of approximating global illumination, as it strikes a balance between visual quality and performance. Light probes are strategically placed throughout the scene, capturing and encoding the incident lighting information using spherical harmonics, a mathematical representation that allows for efficient storage and interpolation of lighting data.<br><br>By incorporating this technique into our engine, we aimed to enhance the visual fidelity of our scenes, creating more realistic and natural-looking lighting conditions that better mimic the behaviour of light in the real world.</p><h2 id="mcetoc_1hqvdsa0k15t">Results</h2><p>Here is a showcase of some test scenes, with and without global illumination enabled:</p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-translation="Add images" data-columns="3"><figure class="gallery__item"><a href="./media/posts/11/gallery/Launcher_Debug_fmCYlmRabl.png" data-size="1920x1080"><img loading="lazy" src="./media/posts/11/gallery/Launcher_Debug_fmCYlmRabl-thumbnail.png" alt="" width="720" height="405"></a><figcaption>Without Global Illumination</figcaption></figure><figure class="gallery__item"><a href="./media/posts/11/gallery/Launcher_Debug_xnfl0cFPxK.png" data-size="1920x1080"><img loading="lazy" src="./media/posts/11/gallery/Launcher_Debug_xnfl0cFPxK-thumbnail.png" alt="" width="720" height="405"></a><figcaption>With Global Illumination</figcaption></figure></div></div><p>In this Cornell box scene, the impact of global illumination is clearly visible. Without GI, the objects appear flat and lack the color bleeding effects that occur when light bounces off colored surfaces. With GI enabled, the red and green walls cast a tint on the nearby objects, creating a more realistic and visually pleasing result. The added indirect lighting helps to soften shadows and enhance the overall sense of depth and dimensionality in the scene.</p><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-translation="Add images" data-columns="3"><figure class="gallery__item"><a href="./media/posts/11/gallery/Launcher_Release_Py3kZ9cTs9-2.png" data-size="1920x1080"><img loading="lazy" src="./media/posts/11/gallery/Launcher_Release_Py3kZ9cTs9-2-thumbnail.png" alt="" width="720" height="405"></a><figcaption>Without Global Illumination</figcaption></figure><figure class="gallery__item"><a href="./media/posts/11/gallery/Launcher_Release_9PWQC6W7yq.png" data-size="1920x1080"><img loading="lazy" src="./media/posts/11/gallery/Launcher_Release_9PWQC6W7yq-thumbnail.png" alt="" width="720" height="405"></a><figcaption>With Global Illumination</figcaption></figure></div></div><p>The box scene with a top opening demonstrates the importance of indirect lighting in enclosed environments. Without GI, only the areas directly exposed to the light source are illuminated, leaving the rest of the interior in complete darkness. With GI enabled, the light entering through the opening bounces off the interior surfaces, spreading illumination to areas that are not in direct line of sight of the light source. This creates a more realistic and natural-looking result, as it mimics how light behaves in real-world enclosed spaces, enhancing the overall sense of depth and realism in the scene.</p><p>Performance-wise, this method of implementing global illumination is relatively cheap in terms of runtime overhead, as the precomputed lighting data can be efficiently accessed and interpolated during rendering.</p><h2 id="mcetoc_1hqvdsa0k15u">Techical Implementation</h2><p>The process of baking a light probe could be broken down into a 3 step process:</p><ul><li>Render the scene into a cube map as our radiance map.</li><li>Convert the radiance map to a irradiance map.</li><li>Project the irradiance map into spherical harmonic values.</li></ul><div>In total I ended up with this function:</div><div><pre class="language-cpp"><code>void Light_Probe_Manager::update_probe(int index, std::function&lt;void(Cube_Map_Render_Target*)&gt; render_func)
{
Light_Probe&amp; light_probe = light_probes[index];


cube_map_radiance_target.SetPosition(light_probe.position);


render_func(&amp;cube_map_radiance_target);


CubeMapRenderTarget* cube_map = &amp;cube_map_radiance_target;
#if ENABLE_IRRADIANCE
convert_radiance_to_irradiance_map(&amp;cube_map_radiance_target, &amp;cube_map_irradiance_target);
cube_map = &amp;cube_map_irradiance_target;
#endif


float r[9] = {};
float g[9] = {};
float b[9] = {};
  project_cube_map_to_sh(r, g, b, cube_map);


memcpy(light_probe.r, r, sizeof(r));
memcpy(light_probe.g, g, sizeof(g));
memcpy(light_probe.b, b, sizeof(b));
}</code></pre></div><div> </div><div>Then to use this in a pixel shader I sample the 8 closest light probes and tri-linearly interpolate in between them to get smooth transitions between light probes.</div><div>I ended up with this as my sampling code:</div><div><pre class="language-cpp"><code>float3 color[8];
for (int i = 0; i &lt; 8; i++)
{
    Light_Probe probe = light_probe_buffer[indices[i]];


    float basis[9];
    sh_eval_basis_2(dir, basis);


    color[i].r = sh_dot_order3(basis, probe.r);
    color[i].g = sh_dot_order3(basis, probe.g);
    color[i].b = sh_dot_order3(basis, probe.b);
}</code></pre></div><div> </div><div>An example of non-interpolated and interpolated:</div><div><div class="gallery-wrapper"><div class="gallery" data-is-empty="false" data-translation="Add images" data-columns="3"><figure class="gallery__item"><a href="./media/posts/11/gallery/Launcher_Release_J6ragZoAaM.png" data-size="1920x1080"><img loading="lazy" src="./media/posts/11/gallery/Launcher_Release_J6ragZoAaM-thumbnail.png" alt="" width="720" height="405"></a><figcaption>Without Trilinear Interpolation</figcaption></figure><figure class="gallery__item"><a href="./media/posts/11/gallery/Launcher_Release_kwRUAeCbTF-2.png" data-size="1920x1080"><img loading="lazy" src="./media/posts/11/gallery/Launcher_Release_kwRUAeCbTF-2-thumbnail.png" alt="" width="720" height="405"></a><figcaption>With Trilinear Interpolation</figcaption></figure></div></div><p>This ended up being my interpolation code:</p></div><div><pre class="language-cpp"><code>// Tri-linear interpolation
float back_to_front_weight = (position_ws.z - min_bounds.z) / (max_bounds.z - min_bounds.z);
float bottom_to_top_weight = (position_ws.y - min_bounds.y) / (max_bounds.y - min_bounds.y);
float left_to_right_weight = (position_ws.x - min_bounds.x) / (max_bounds.x - min_bounds.x);


float3 color_0 = lerp(color[0], color[1], left_to_right_weight);
float3 color_1 = lerp(color[2], color[3], left_to_right_weight);
float3 color_2 = lerp(color[4], color[5], left_to_right_weight);
float3 color_3 = lerp(color[6], color[7], left_to_right_weight);


float3 color_4 = lerp(color_0, color_1, bottom_to_top_weight);
float3 color_5 = lerp(color_2, color_3, bottom_to_top_weight);


return lerp(color_4, color_5, back_to_front_weight);</code></pre></div><div> </div></div></article></main><footer class="footer"><div class="footer__copyright"><p>         </p><p>         </p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="./assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script defer="defer" src="./assets/js/scripts.min.js?v=f47c11534595205f20935f0db2a62a85"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 240,doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script defer="defer" src="./assets/js/photoswipe.min.js?v=b586a3bc288c989ecce7b81b48e35855"></script><script defer="defer" src="./assets/js/photoswipe-ui-default.min.js?v=9952f77ca2b8fbc9449a268008ea8dee"></script><script>var initPhotoSwipeFromDOM=function(gallerySelector){var parseThumbnailElements=function(el){var thumbElements=el.childNodes,numNodes=thumbElements.length,items=[],figureEl,linkEl,size,item;for(var i=0;i<numNodes;i++){figureEl=thumbElements[i];if(figureEl.nodeType!==1){continue;}
          linkEl=figureEl.children[0];size=linkEl.getAttribute('data-size').split('x');item={src:linkEl.getAttribute('href'),w:parseInt(size[0],10),h:parseInt(size[1],10)};if(figureEl.children.length>1){item.title=figureEl.children[1].innerHTML;}
          if(linkEl.children.length>0){item.msrc=linkEl.children[0].getAttribute('src');}
          item.el=figureEl;items.push(item);}
          return items;};var closest=function closest(el,fn){return el&&(fn(el)?el:closest(el.parentNode,fn));};var onThumbnailsClick=function(e){e=e||window.event;e.preventDefault?e.preventDefault():e.returnValue=false;var eTarget=e.target||e.srcElement;var clickedListItem=closest(eTarget,function(el){return(el.tagName&&el.tagName.toUpperCase()==='FIGURE');});if(!clickedListItem){return;}
          var clickedGallery=clickedListItem.parentNode,childNodes=clickedListItem.parentNode.childNodes,numChildNodes=childNodes.length,nodeIndex=0,index;for(var i=0;i<numChildNodes;i++){if(childNodes[i].nodeType!==1){continue;}
          if(childNodes[i]===clickedListItem){index=nodeIndex;break;}
          nodeIndex++;}
          if(index>=0){openPhotoSwipe(index,clickedGallery);}
          return false;};var photoswipeParseHash=function(){var hash=window.location.hash.substring(1),params={};if(hash.length<5){return params;}
          var vars=hash.split('&');for(var i=0;i<vars.length;i++){if(!vars[i]){continue;}
          var pair=vars[i].split('=');if(pair.length<2){continue;}
          params[pair[0]]=pair[1];}
          if(params.gid){params.gid=parseInt(params.gid,10);}
          return params;};var openPhotoSwipe=function(index,galleryElement,disableAnimation,fromURL){var pswpElement=document.querySelectorAll('.pswp')[0],gallery,options,items;items=parseThumbnailElements(galleryElement);options={galleryUID:galleryElement.getAttribute('data-pswp-uid'),getThumbBoundsFn:function(index){var thumbnail=items[index].el.getElementsByTagName('img')[0],pageYScroll=window.pageYOffset||document.documentElement.scrollTop,rect=thumbnail.getBoundingClientRect();return{x:rect.left,y:rect.top+pageYScroll,w:rect.width};},
          mainClass:'pswp--dark',
          preload: [1,2],
          hideAnimationDuration:200,
          showAnimationDuration:0,
          bgOpacity: 0.7,
          showHideOpacity:true,
          closeOnScroll: true,
          arrowKeys: true,
          closeEl: true,
          captionEl: true,
          fullscreenEl: true,
          zoomEl: true,
          shareEl: true,
          counterEl: true,
          arrowEl: true,
          preloaderEl: true
          };if(fromURL){if(options.galleryPIDs){for(var j=0;j<items.length;j++){if(items[j].pid==index){options.index=j;break;}}}else{options.index=parseInt(index,10)-1;}}else{options.index=parseInt(index,10);}
          if(isNaN(options.index)){return;}
          if(disableAnimation){options.showAnimationDuration=0;}
          gallery=new PhotoSwipe(pswpElement,PhotoSwipeUI_Default,items,options);gallery.init();gallery.options.escKey=true;};var galleryElements=document.querySelectorAll(gallerySelector);for(var i=0,l=galleryElements.length;i<l;i++){galleryElements[i].setAttribute('data-pswp-uid',i+1);galleryElements[i].onclick=onThumbnailsClick;}
          var hashData=photoswipeParseHash();if(hashData.pid&&hashData.gid){openPhotoSwipe(hashData.pid,galleryElements[hashData.gid-1],true,true);}};window.addEventListener('load', function () {initPhotoSwipeFromDOM('.gallery');}, false);</script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button><button class="pswp__button pswp__button--share" title="Share"></button><button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button><button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button><button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script defer="defer" src="./media/plugins/syntaxHighlighter/prism.js"></script></body></html>